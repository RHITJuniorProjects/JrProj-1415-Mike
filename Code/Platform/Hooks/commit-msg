#!/usr/bin/python
import sys
import re
import subprocess
from firebase import firebase

prodUrl = 'https://henry-production.firebaseio.com'
stagUrl = 'https://henry-staging.firebaseio.com'
testUrl = 'https://henry-test.firebaseio.com'

def getLoC():
    command = 'git diff --cached --shortstat'.split(' ')
    pipe = subprocess.Popen(command,stdout=subprocess.PIPE)
    pair = pipe.communicate()[0]
    vals = pair.replace(' ','').split(',') 
    if len(vals) == 3:
        vals = vals[1:]
    elif len(vals) == 2:
        vals = [vals[1]]+['0'] if 'insertion' in pair else ['0']+[vals[1]]
    elif len(vals) == 1:
        raise Exception('HENRY: Unexpected output of `git diff --cached --shortstat`')
    else:
        vals = ['0','0']
    nums = map(lambda x: int(x[0]),vals) 
    return nums[0] - nums[1]

def parse(msg):
    hoursRE = r"\[hours:([0-9]+)\]"
    milestoneRE = r"\[milestone:([0-9]+)\]"
    taskRE = r"\[task:([0-9]+)\]"

    hours = re.search(hoursRE,msg).group(1)
    milestone = re.search(milestoneRE,msg).group(1)
    task = re.search(taskRE,msg).group(1)


# set this to the correct database
firebase = firebase.FirebaseApplication(testUrl, None)

username = 'aj-michael'

users = firebase.get('/users',None)
try:
    uid = [u for u in users if users[u]['github']==username][0]
except:
    raise Exception('HENRY: Invalid username, commit failed')

# sys.argv[0] is the path to this file
# sys.argv[1] is the path to commit file
with open(sys.argv[1], "r") as msgfile:
    msg = msgfile.read()

parse(msg)


path = '/users'

x = range(0,2)

#print x[5]

"""
# no hour included
if hours == None:
    print "Hours not included, set to zero by default"
    hours = 0
else:
    hours = hours.group(1)

print "Hours were: " + str(hours)
"""


"""
print firebase.get('/user', None)
path = '/users'
key = 'Sample user'
value = 'Sample field'
firebase.put(path, key, value)
"""

